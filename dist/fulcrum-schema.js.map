{"version":3,"file":"fulcrum-schema.js","names":["Postgres","sqldiff","SQLite","SchemaDiffer","instance","Function","dialect","version","oldForm","newForm","tableSchema","tablePrefix","includeMetadata","generateSQL","differ","Generator","postgres","sqlite","quote","meta","Metadata","schema","includeColumns","generator","afterTransform","build","bind","generate","compareOrganization","oldSchema","newSchema","oldOrganization","OrganizationSchema","OrganizationSchemaV2","newOrganization","compareFormSchemas","options","schemas","v1","FormSchemaV1","v2","FormSchemaV2","v3","FormSchemaV3","v4","FormSchemaV4","columns","schema_version","Schema","err","Error","stack","toString","compareForms","module","exports"],"sources":["../src/fulcrum-schema.js"],"sourcesContent":["import OrganizationSchema from './organization-schema';\nimport Schema from './schema';\nimport OrganizationSchemaV2 from './schemas/postgres-schema';\nimport FormSchemaV1 from './schemas/v1';\nimport FormSchemaV2 from './schemas/v2';\nimport FormSchemaV3 from './schemas/v3';\nimport FormSchemaV4 from './schemas/v4';\nimport Metadata from './metadata';\nimport sqldiff from 'sqldiff';\n\nconst { Postgres, SQLite, SchemaDiffer } = sqldiff;\n\nconst instance = Function('return this')(); // eslint-disable-line no-new-func\n\ninstance.dialect = 'postgres';\ninstance.version = 'v2';\ninstance.oldForm = null;\ninstance.newForm = null;\ninstance.tableSchema = null;\ninstance.tablePrefix = null;\ninstance.includeMetadata = false;\n\nfunction generateSQL(differ, { includeMetadata, dialect, tablePrefix, tableSchema }) {\n  const Generator = {\n    postgres: Postgres,\n    sqlite: SQLite\n  }[dialect];\n\n  const quote = {\n    postgres: '\"',\n    sqlite: '`'\n  }[dialect];\n\n  const meta = new Metadata(differ, { quote, schema: tableSchema, includeColumns: true });\n\n  const generator = new Generator(differ, { afterTransform: includeMetadata ? meta.build.bind(meta) : null });\n\n  generator.tableSchema = tableSchema || '';\n  generator.tablePrefix = tablePrefix || '';\n\n  return generator.generate();\n}\n\ninstance.compareOrganization = () => {\n  let oldSchema = null;\n  let newSchema = null;\n\n  if (instance.oldOrganization) {\n    oldSchema = new OrganizationSchema(OrganizationSchemaV2);\n  }\n\n  if (instance.newOrganization) {\n    newSchema = new OrganizationSchema(OrganizationSchemaV2);\n  }\n\n  const differ = new SchemaDiffer(oldSchema, newSchema);\n\n  return generateSQL(differ, {\n    version: instance.version,\n    dialect: instance.dialect,\n    tableSchema: instance.tableSchema,\n    tablePrefix: instance.tablePrefix,\n    includeMetadata: true\n  });\n};\n\ninstance.compareFormSchemas = (oldForm, newForm, options = {}) => {\n  try {\n    let oldSchema = null;\n    let newSchema = null;\n\n    const schemas = {\n      v1: FormSchemaV1,\n      v2: FormSchemaV2,\n      v3: FormSchemaV3,\n      v4: FormSchemaV4\n    };\n\n    if (oldForm) {\n      const columns = schemas[options.version || oldForm.schema_version];\n      oldSchema = new Schema(oldForm, columns, null);\n    }\n\n    if (newForm) {\n      const columns = schemas[options.version || newForm.schema_version];\n      newSchema = new Schema(newForm, columns, null);\n    }\n\n    const differ = new SchemaDiffer(oldSchema, newSchema);\n\n    return generateSQL(differ, options);\n  } catch (err) {\n    throw new Error(err.stack.toString());\n  }\n};\n\ninstance.compareForms = () => {\n  return instance.compareFormSchemas(\n    instance.oldForm,\n    instance.newForm,\n    {\n      version: instance.version,\n      dialect: instance.dialect,\n      tableSchema: instance.tableSchema,\n      tablePrefix: instance.tablePrefix,\n      includeMetadata: instance.includeMetadata\n    }\n  );\n};\n\nmodule.exports = instance;\n"],"mappings":"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"}