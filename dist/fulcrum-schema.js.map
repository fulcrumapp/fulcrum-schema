{"version":3,"file":"fulcrum-schema.js","names":["require","Postgres","sqldiff","SQLite","SchemaDiffer","instance","Function","dialect","version","oldForm","newForm","tableSchema","tablePrefix","includeMetadata","generateSQL","differ","Generator","postgres","sqlite","quote","meta","Metadata","schema","includeColumns","generator","afterTransform","build","bind","generate","compareOrganization","oldSchema","newSchema","oldOrganization","OrganizationSchema","OrganizationSchemaV2","newOrganization","compareFormSchemas","options","schemas","v1","FormSchemaV1","v2","FormSchemaV2","v3","FormSchemaV3","v4","FormSchemaV4","columns","schema_version","Schema","err","Error","stack","toString","compareForms","module","exports"],"sources":["../src/fulcrum-schema.js"],"sourcesContent":["require('@babel/polyfill');\n\nimport OrganizationSchema from './organization-schema';\nimport Schema from './schema';\nimport OrganizationSchemaV2 from './schemas/postgres-schema';\nimport FormSchemaV1 from './schemas/v1';\nimport FormSchemaV2 from './schemas/v2';\nimport FormSchemaV3 from './schemas/v3';\nimport FormSchemaV4 from './schemas/v4';\nimport Metadata from './metadata';\nimport sqldiff from 'sqldiff';\n\nconst { Postgres, SQLite, SchemaDiffer } = sqldiff;\n\nconst instance = Function('return this')(); // eslint-disable-line no-new-func\n\ninstance.dialect = 'postgres';\ninstance.version = 'v2';\ninstance.oldForm = null;\ninstance.newForm = null;\ninstance.tableSchema = null;\ninstance.tablePrefix = null;\ninstance.includeMetadata = false;\n\nfunction generateSQL(differ, { includeMetadata, dialect, tablePrefix, tableSchema }) {\n  const Generator = {\n    postgres: Postgres,\n    sqlite: SQLite\n  }[dialect];\n\n  const quote = {\n    postgres: '\"',\n    sqlite: '`'\n  }[dialect];\n\n  const meta = new Metadata(differ, { quote, schema: tableSchema, includeColumns: true });\n\n  const generator = new Generator(differ, { afterTransform: includeMetadata ? meta.build.bind(meta) : null });\n\n  generator.tableSchema = tableSchema || '';\n  generator.tablePrefix = tablePrefix || '';\n\n  return generator.generate();\n}\n\ninstance.compareOrganization = () => {\n  let oldSchema = null;\n  let newSchema = null;\n\n  if (instance.oldOrganization) {\n    oldSchema = new OrganizationSchema(OrganizationSchemaV2);\n  }\n\n  if (instance.newOrganization) {\n    newSchema = new OrganizationSchema(OrganizationSchemaV2);\n  }\n\n  const differ = new SchemaDiffer(oldSchema, newSchema);\n\n  return generateSQL(differ, {\n    version: instance.version,\n    dialect: instance.dialect,\n    tableSchema: instance.tableSchema,\n    tablePrefix: instance.tablePrefix,\n    includeMetadata: true\n  });\n};\n\ninstance.compareFormSchemas = (oldForm, newForm, options = {}) => {\n  try {\n    let oldSchema = null;\n    let newSchema = null;\n\n    const schemas = {\n      v1: FormSchemaV1,\n      v2: FormSchemaV2,\n      v3: FormSchemaV3,\n      v4: FormSchemaV4\n    };\n\n    if (oldForm) {\n      const columns = schemas[options.version || oldForm.schema_version];\n      oldSchema = new Schema(oldForm, columns, null);\n    }\n\n    if (newForm) {\n      const columns = schemas[options.version || newForm.schema_version];\n      newSchema = new Schema(newForm, columns, null);\n    }\n\n    const differ = new SchemaDiffer(oldSchema, newSchema);\n\n    return generateSQL(differ, options);\n  } catch (err) {\n    throw new Error(err.stack.toString());\n  }\n};\n\ninstance.compareForms = () => {\n  return instance.compareFormSchemas(\n    instance.oldForm,\n    instance.newForm,\n    {\n      version: instance.version,\n      dialect: instance.dialect,\n      tableSchema: instance.tableSchema,\n      tablePrefix: instance.tablePrefix,\n      includeMetadata: instance.includeMetadata\n    }\n  );\n};\n\nmodule.exports = instance;\n"],"mappings":"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"}