{"version":3,"sources":["../src/organization-schema.js"],"names":[],"mappings":"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","file":"organization-schema.js","sourcesContent":["import _ from 'underscore';\nimport sqldiff from 'sqldiff';\n\nconst {Table, View} = sqldiff;\n\nexport default class OrganizationSchema {\n  constructor(schema, options) {\n    this.schema = schema;\n    this.options = options || {};\n    this.buildSchema();\n  }\n\n  buildSchema() {\n    this.tables = [];\n    this.views = [];\n\n    this.buildTable('changesets', this.schema.systemChangesetsTable);\n    this.buildTable('forms', this.schema.systemFormsTable);\n    this.buildTable('choice_lists', this.schema.systemChoiceListsTable);\n    this.buildTable('classification_sets', this.schema.systemClassificationSetsTable);\n    this.buildTable('projects', this.schema.systemProjectsTable);\n    this.buildTable('roles', this.schema.systemRolesTable);\n    this.buildTable('memberships', this.schema.systemMembershipsTable);\n    this.buildTable('photos', this.schema.systemPhotosTable);\n    this.buildTable('videos', this.schema.systemVideosTable);\n    this.buildTable('audio', this.schema.systemAudioTable);\n    this.buildTable('signatures', this.schema.systemSignaturesTable);\n\n    this.buildViews();\n  }\n\n  buildTable(name, definition) {\n    const table = new Table(name, null, {type: 'system', alias: name});\n\n    for (const column of definition) {\n      const systemColumn = _.clone(column);\n\n      systemColumn.system = true;\n\n      table.addColumn(systemColumn);\n    }\n\n    this.tables.push(table);\n  }\n\n  buildViews() {\n    for (const table of this.tables) {\n      const view = new View(table.name + '_view', null, table);\n\n      const columnNames = {};\n\n      for (const column of table.columns) {\n        const alias = this.viewColumnName(table, column);\n\n        if (alias == null) {\n          continue;\n        }\n\n        if (!columnNames[alias]) {\n          view.addColumn({column: column, alias: alias});\n          columnNames[alias] = column;\n        }\n      }\n\n      this.views.push(view);\n    }\n  }\n\n  viewColumnName(table, column) {\n    return this.schema.organizationViews[table.name][column.name];\n  }\n}\n"]}