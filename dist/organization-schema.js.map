{"version":3,"sources":["../src/organization-schema.js"],"names":["Table","View","sqldiff","OrganizationSchema","constructor","schema","options","buildSchema","tables","tableDefinitions","views","table","ModelClass","definition","defineTable","defineView","defineIndexes","name","buildTable","buildViews","tableDefinition","type","alias","column","columns","systemColumn","system","addColumn","indexDefinition","indexes","addIndex","push","replace","view","columnNames","columnAlias","viewColumns","length"],"mappings":";;;;;;;AAAA;;AACA;;;;AAEA,MAAM;AAACA,EAAAA,KAAD;AAAQC,EAAAA;AAAR,IAAgBC,gBAAtB;;AAEe,MAAMC,kBAAN,CAAyB;AACtCC,EAAAA,WAAW,CAACC,MAAD,EAASC,OAAT,EAAkB;AAC3B,SAAKD,MAAL,GAAcA,MAAd;AACA,SAAKC,OAAL,GAAeA,OAAO,IAAI,EAA1B;AACA,SAAKC,WAAL;AACD;;AAEDA,EAAAA,WAAW,GAAG;AACZ,SAAKC,MAAL,GAAc,EAAd;AACA,SAAKC,gBAAL,GAAwB,EAAxB;AACA,SAAKC,KAAL,GAAa,EAAb;;AAEA,SAAK,MAAMC,KAAX,IAAoB,KAAKN,MAAzB,EAAiC;AAC/B,YAAMO,UAAU,GAAGD,KAAnB;AAEA,YAAME,UAAU,GAAG,IAAID,UAAJ,EAAnB;AAEAC,MAAAA,UAAU,CAACC,WAAX;AACAD,MAAAA,UAAU,CAACE,UAAX;AACAF,MAAAA,UAAU,CAACG,aAAX;AAEA,WAAKP,gBAAL,CAAsBI,UAAU,CAACI,IAAjC,IAAyCJ,UAAzC;AAEA,WAAKK,UAAL,CAAgBL,UAAhB;AACD;;AAED,SAAKM,UAAL;AACD;;AAEDD,EAAAA,UAAU,CAACE,eAAD,EAAkB;AAC1B,UAAMT,KAAK,GAAG,IAAIX,KAAJ,CAAUoB,eAAe,CAACH,IAA1B,EAAgC,IAAhC,EAAsC;AAACI,MAAAA,IAAI,EAAE,QAAP;AAAiBC,MAAAA,KAAK,EAAEF,eAAe,CAACH;AAAxC,KAAtC,CAAd;;AAEA,SAAK,MAAMM,MAAX,IAAqBH,eAAe,CAACI,OAArC,EAA8C;AAC5C,YAAMC,YAAY,GAAG,mBAAMF,MAAN,CAArB;AAEAE,MAAAA,YAAY,CAACC,MAAb,GAAsB,IAAtB;AAEAf,MAAAA,KAAK,CAACgB,SAAN,CAAgBF,YAAhB;AACD;;AAED,SAAK,MAAMG,eAAX,IAA8BR,eAAe,CAACS,OAA9C,EAAuD;AACrDlB,MAAAA,KAAK,CAACmB,QAAN,CAAeF,eAAf;AACD;;AAED,SAAKpB,MAAL,CAAYuB,IAAZ,CAAiBpB,KAAjB;AACD;;AAEDQ,EAAAA,UAAU,GAAG;AACX,SAAK,MAAMR,KAAX,IAAoB,KAAKH,MAAzB,EAAiC;AAC/B,YAAMc,KAAK,GAAGX,KAAK,CAACM,IAAN,CAAWe,OAAX,CAAmB,SAAnB,EAA8B,EAA9B,CAAd;AAEA,YAAMC,IAAI,GAAG,IAAIhC,IAAJ,CAASqB,KAAK,GAAG,OAAjB,EAA0B,IAA1B,EAAgCX,KAAhC,EAAuC;AAAEW,QAAAA;AAAF,OAAvC,CAAb;AAEA,YAAMY,WAAW,GAAG,EAApB;AAEA,YAAMrB,UAAU,GAAG,KAAKJ,gBAAL,CAAsBE,KAAK,CAACM,IAA5B,CAAnB;;AAEA,WAAK,MAAMM,MAAX,IAAqBZ,KAAK,CAACa,OAA3B,EAAoC;AAClC,cAAMW,WAAW,GAAGtB,UAAU,CAACuB,WAAX,CAAuBb,MAAM,CAACN,IAA9B,CAApB;;AAEA,YAAIkB,WAAW,IAAI,IAAnB,EAAyB;AACvB;AACA;AACD;;AAED,YAAI,CAACD,WAAW,CAACC,WAAD,CAAhB,EAA+B;AAC7BF,UAAAA,IAAI,CAACN,SAAL,CAAe;AAACJ,YAAAA,MAAM,EAAEA,MAAT;AAAiBD,YAAAA,KAAK,EAAEa;AAAxB,WAAf;AACAD,UAAAA,WAAW,CAACC,WAAD,CAAX,GAA2BZ,MAA3B;AACD;AACF;;AAED,UAAIU,IAAI,CAACT,OAAL,CAAaa,MAAjB,EAAyB;AACvB,aAAK3B,KAAL,CAAWqB,IAAX,CAAgBE,IAAhB;AACD;AACF;AACF;;AA3EqC","sourcesContent":["import { clone } from 'lodash';\nimport sqldiff from 'sqldiff';\n\nconst {Table, View} = sqldiff;\n\nexport default class OrganizationSchema {\n  constructor(schema, options) {\n    this.schema = schema;\n    this.options = options || {};\n    this.buildSchema();\n  }\n\n  buildSchema() {\n    this.tables = [];\n    this.tableDefinitions = {};\n    this.views = [];\n\n    for (const table of this.schema) {\n      const ModelClass = table;\n\n      const definition = new ModelClass();\n\n      definition.defineTable();\n      definition.defineView();\n      definition.defineIndexes();\n\n      this.tableDefinitions[definition.name] = definition;\n\n      this.buildTable(definition);\n    }\n\n    this.buildViews();\n  }\n\n  buildTable(tableDefinition) {\n    const table = new Table(tableDefinition.name, null, {type: 'system', alias: tableDefinition.name});\n\n    for (const column of tableDefinition.columns) {\n      const systemColumn = clone(column);\n\n      systemColumn.system = true;\n\n      table.addColumn(systemColumn);\n    }\n\n    for (const indexDefinition of tableDefinition.indexes) {\n      table.addIndex(indexDefinition);\n    }\n\n    this.tables.push(table);\n  }\n\n  buildViews() {\n    for (const table of this.tables) {\n      const alias = table.name.replace(/^query_/, '');\n\n      const view = new View(alias + '_view', null, table, { alias });\n\n      const columnNames = {};\n\n      const definition = this.tableDefinitions[table.name];\n\n      for (const column of table.columns) {\n        const columnAlias = definition.viewColumns[column.name];\n\n        if (columnAlias == null) {\n          // console.log('Skipping ' + table.name + '.' + column.name + ' in view.');\n          continue;\n        }\n\n        if (!columnNames[columnAlias]) {\n          view.addColumn({column: column, alias: columnAlias});\n          columnNames[columnAlias] = column;\n        }\n      }\n\n      if (view.columns.length) {\n        this.views.push(view);\n      }\n    }\n  }\n}\n"],"file":"organization-schema.js"}