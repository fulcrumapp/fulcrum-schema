{"version":3,"file":"organization-schema.js","names":["Table","sqldiff","View","OrganizationSchema","schema","options","buildSchema","tables","tableDefinitions","views","table","ModelClass","definition","defineTable","defineView","defineIndexes","name","buildTable","buildViews","tableDefinition","type","alias","columns","column","systemColumn","clone","system","addColumn","indexes","indexDefinition","addIndex","push","replace","view","columnNames","columnAlias","viewColumns","length"],"sources":["../src/organization-schema.js"],"sourcesContent":["import { clone } from 'lodash';\nimport sqldiff from 'sqldiff';\n\nconst {Table, View} = sqldiff;\n\nexport default class OrganizationSchema {\n  constructor(schema, options) {\n    this.schema = schema;\n    this.options = options || {};\n    this.buildSchema();\n  }\n\n  buildSchema() {\n    this.tables = [];\n    this.tableDefinitions = {};\n    this.views = [];\n\n    for (const table of this.schema) {\n      const ModelClass = table;\n\n      const definition = new ModelClass();\n\n      definition.defineTable();\n      definition.defineView();\n      definition.defineIndexes();\n\n      this.tableDefinitions[definition.name] = definition;\n\n      this.buildTable(definition);\n    }\n\n    this.buildViews();\n  }\n\n  buildTable(tableDefinition) {\n    const table = new Table(tableDefinition.name, null, {type: 'system', alias: tableDefinition.name});\n\n    for (const column of tableDefinition.columns) {\n      const systemColumn = clone(column);\n\n      systemColumn.system = true;\n\n      table.addColumn(systemColumn);\n    }\n\n    for (const indexDefinition of tableDefinition.indexes) {\n      table.addIndex(indexDefinition);\n    }\n\n    this.tables.push(table);\n  }\n\n  buildViews() {\n    for (const table of this.tables) {\n      const alias = table.name.replace(/^query_/, '');\n\n      const view = new View(alias + '_view', null, table, { alias });\n\n      const columnNames = {};\n\n      const definition = this.tableDefinitions[table.name];\n\n      for (const column of table.columns) {\n        const columnAlias = definition.viewColumns[column.name];\n\n        if (columnAlias == null) {\n          // console.log('Skipping ' + table.name + '.' + column.name + ' in view.');\n          continue;\n        }\n\n        if (!columnNames[columnAlias]) {\n          view.addColumn({column: column, alias: columnAlias});\n          columnNames[columnAlias] = column;\n        }\n      }\n\n      if (view.columns.length) {\n        this.views.push(view);\n      }\n    }\n  }\n}\n"],"mappings":"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"}