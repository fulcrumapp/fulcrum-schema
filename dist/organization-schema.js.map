{"version":3,"file":"organization-schema.js","names":["Table","sqldiff","View","OrganizationSchema","schema","options","buildSchema","tables","tableDefinitions","views","table","ModelClass","definition","defineTable","defineView","defineIndexes","name","buildTable","buildViews","tableDefinition","type","alias","columns","column","systemColumn","clone","system","addColumn","indexes","indexDefinition","addIndex","push","replace","view","columnNames","columnAlias","viewColumns","length"],"sources":["../src/organization-schema.js"],"sourcesContent":["import { clone } from 'lodash';\nimport sqldiff from 'sqldiff';\n\nconst {Table, View} = sqldiff;\n\nexport default class OrganizationSchema {\n  constructor(schema, options) {\n    this.schema = schema;\n    this.options = options || {};\n    this.buildSchema();\n  }\n\n  buildSchema() {\n    this.tables = [];\n    this.tableDefinitions = {};\n    this.views = [];\n\n    for (const table of this.schema) {\n      const ModelClass = table;\n\n      const definition = new ModelClass();\n\n      definition.defineTable();\n      definition.defineView();\n      definition.defineIndexes();\n\n      this.tableDefinitions[definition.name] = definition;\n\n      this.buildTable(definition);\n    }\n\n    this.buildViews();\n  }\n\n  buildTable(tableDefinition) {\n    const table = new Table(tableDefinition.name, null, {type: 'system', alias: tableDefinition.name});\n\n    for (const column of tableDefinition.columns) {\n      const systemColumn = clone(column);\n\n      systemColumn.system = true;\n\n      table.addColumn(systemColumn);\n    }\n\n    for (const indexDefinition of tableDefinition.indexes) {\n      table.addIndex(indexDefinition);\n    }\n\n    this.tables.push(table);\n  }\n\n  buildViews() {\n    for (const table of this.tables) {\n      const alias = table.name.replace(/^query_/, '');\n\n      const view = new View(alias + '_view', null, table, { alias });\n\n      const columnNames = {};\n\n      const definition = this.tableDefinitions[table.name];\n\n      for (const column of table.columns) {\n        const columnAlias = definition.viewColumns[column.name];\n\n        if (columnAlias == null) {\n          // console.log('Skipping ' + table.name + '.' + column.name + ' in view.');\n          continue;\n        }\n\n        if (!columnNames[columnAlias]) {\n          view.addColumn({column: column, alias: columnAlias});\n          columnNames[columnAlias] = column;\n        }\n      }\n\n      if (view.columns.length) {\n        this.views.push(view);\n      }\n    }\n  }\n}\n"],"mappings":";;;;;;;AAAA;;AACA;;;;;;;;;;AAEA,IAAOA,KAAP,GAAsBC,mBAAtB,CAAOD,KAAP;AAAA,IAAcE,IAAd,GAAsBD,mBAAtB,CAAcC,IAAd;;IAEqBC,kB;EACnB,4BAAYC,MAAZ,EAAoBC,OAApB,EAA6B;IAC3B,KAAKD,MAAL,GAAcA,MAAd;IACA,KAAKC,OAAL,GAAeA,OAAO,IAAI,EAA1B;IACA,KAAKC,WAAL;EACD;;;;SAEDA,W,GAAA,uBAAc;IACZ,KAAKC,MAAL,GAAc,EAAd;IACA,KAAKC,gBAAL,GAAwB,EAAxB;IACA,KAAKC,KAAL,GAAa,EAAb;;IAEA,qDAAoB,KAAKL,MAAzB,wCAAiC;MAAA,IAAtBM,KAAsB;MAC/B,IAAMC,UAAU,GAAGD,KAAnB;MAEA,IAAME,UAAU,GAAG,IAAID,UAAJ,EAAnB;MAEAC,UAAU,CAACC,WAAX;MACAD,UAAU,CAACE,UAAX;MACAF,UAAU,CAACG,aAAX;MAEA,KAAKP,gBAAL,CAAsBI,UAAU,CAACI,IAAjC,IAAyCJ,UAAzC;MAEA,KAAKK,UAAL,CAAgBL,UAAhB;IACD;;IAED,KAAKM,UAAL;EACD,C;;SAEDD,U,GAAA,oBAAWE,eAAX,EAA4B;IAC1B,IAAMT,KAAK,GAAG,IAAIV,KAAJ,CAAUmB,eAAe,CAACH,IAA1B,EAAgC,IAAhC,EAAsC;MAACI,IAAI,EAAE,QAAP;MAAiBC,KAAK,EAAEF,eAAe,CAACH;IAAxC,CAAtC,CAAd;;IAEA,sDAAqBG,eAAe,CAACG,OAArC,2CAA8C;MAAA,IAAnCC,MAAmC;MAC5C,IAAMC,YAAY,GAAG,IAAAC,aAAA,EAAMF,MAAN,CAArB;MAEAC,YAAY,CAACE,MAAb,GAAsB,IAAtB;MAEAhB,KAAK,CAACiB,SAAN,CAAgBH,YAAhB;IACD;;IAED,sDAA8BL,eAAe,CAACS,OAA9C,2CAAuD;MAAA,IAA5CC,eAA4C;MACrDnB,KAAK,CAACoB,QAAN,CAAeD,eAAf;IACD;;IAED,KAAKtB,MAAL,CAAYwB,IAAZ,CAAiBrB,KAAjB;EACD,C;;SAEDQ,U,GAAA,sBAAa;IACX,sDAAoB,KAAKX,MAAzB,2CAAiC;MAAA,IAAtBG,KAAsB;MAC/B,IAAMW,KAAK,GAAGX,KAAK,CAACM,IAAN,CAAWgB,OAAX,CAAmB,SAAnB,EAA8B,EAA9B,CAAd;MAEA,IAAMC,IAAI,GAAG,IAAI/B,IAAJ,CAASmB,KAAK,GAAG,OAAjB,EAA0B,IAA1B,EAAgCX,KAAhC,EAAuC;QAAEW,KAAK,EAALA;MAAF,CAAvC,CAAb;MAEA,IAAMa,WAAW,GAAG,EAApB;MAEA,IAAMtB,UAAU,GAAG,KAAKJ,gBAAL,CAAsBE,KAAK,CAACM,IAA5B,CAAnB;;MAEA,sDAAqBN,KAAK,CAACY,OAA3B,2CAAoC;QAAA,IAAzBC,MAAyB;QAClC,IAAMY,WAAW,GAAGvB,UAAU,CAACwB,WAAX,CAAuBb,MAAM,CAACP,IAA9B,CAApB;;QAEA,IAAImB,WAAW,IAAI,IAAnB,EAAyB;UACvB;UACA;QACD;;QAED,IAAI,CAACD,WAAW,CAACC,WAAD,CAAhB,EAA+B;UAC7BF,IAAI,CAACN,SAAL,CAAe;YAACJ,MAAM,EAAEA,MAAT;YAAiBF,KAAK,EAAEc;UAAxB,CAAf;UACAD,WAAW,CAACC,WAAD,CAAX,GAA2BZ,MAA3B;QACD;MACF;;MAED,IAAIU,IAAI,CAACX,OAAL,CAAae,MAAjB,EAAyB;QACvB,KAAK5B,KAAL,CAAWsB,IAAX,CAAgBE,IAAhB;MACD;IACF;EACF,C"}