{"version":3,"sources":["../src/schema.js"],"names":[],"mappings":"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","file":"schema.js","sourcesContent":["import _ from 'underscore';\nimport Utils from './utils';\nimport sqldiff from 'sqldiff';\nimport {format} from 'util';\nimport DataElements from './data-elements';\n\nconst {Table, View} = sqldiff;\n\nexport default class Schema {\n  constructor(form, columns, options) {\n    this.prefix = 'f';\n    this.form = form;\n    this.columns = columns;\n    this.options = options || {};\n    this.elements = Utils.flattenElements(this.form.elements, false);\n    this.schemaElements = DataElements.find(this.elements);\n    this.buildSchema();\n  }\n\n  buildSchema() {\n    this.tables = [];\n    this.views = [];\n\n    this.formTable = this.buildFormTable();\n    this.valuesTable = this.buildValuesTable();\n\n    this.tables.push(this.formTable);\n    this.tables.push(this.valuesTable);\n\n    this.buildDataColumns();\n    this.buildViews();\n  }\n\n  alias(part) {\n    if (part) {\n      return this.form.name + '/' + part;\n    }\n    return this.form.name;\n  }\n\n  buildFormTable() {\n    const table = new Table(format('form_%s', this.form.row_id),\n                            null,\n                            {type: 'form', alias: this.alias(), form_id: this.form.id});\n\n    for (const column of this.columns.systemFormTableColumns) {\n      const formColumn = _.clone(column);\n\n      formColumn.system = true;\n\n      table.addColumn(formColumn);\n    }\n\n    return table;\n  }\n\n  buildValuesTable() {\n    const table = new Table(format('form_%s_values', this.form.row_id),\n                            null,\n                            {type: 'values', alias: this.alias('values'), form_id: this.form.id});\n\n    for (const column of this.columns.systemValuesTableColumns) {\n      const valueColumn = _.clone(column);\n\n      valueColumn.system = true;\n\n      table.addColumn(valueColumn);\n    }\n\n    return table;\n  }\n\n  buildRepeatableTable(parentTable, element) {\n    const table = new Table(this.formTable.id + '_' + element.key,\n                            null,\n                            {type: 'repeatable', parent: parentTable, alias: this.alias(element.data_name), form_id: this.form.id});\n\n    for (const column of this.columns.systemRepeatableTableColumns) {\n      const attrs = _.clone(column);\n\n      attrs.id = element.key + '_' + column.name;\n      attrs.system = true;\n\n      table.addColumn(attrs);\n    }\n\n    return table;\n  }\n\n  buildDataColumns() {\n    for (const element of this.schemaElements) {\n      this.processElement(element, this.formTable);\n    }\n  }\n\n  buildViews() {\n    this.viewColumns = {};\n\n    for (const table of this.tables) {\n      if (table.type === 'values') {\n        // skip value table for now\n        continue;\n      }\n\n      const view = new View(table.name + '_view', null, table);\n\n      const columnNames = {};\n\n      for (const column of table.columns) {\n        let alias = this.viewColumnName(table, column);\n\n        if (alias == null) {\n          continue;\n        }\n\n        if (!columnNames[alias]) {\n          view.addColumn({column: column, alias: alias});\n          columnNames[alias] = column;\n        }\n      }\n\n      this.views.push(view);\n    }\n  }\n\n  viewColumnName(table, column) {\n    let name = null;\n\n    if (column.system) {\n      if (table.type === 'form') {\n        name = this.columns.systemFormViewColumns[column.name];\n      } else if (table.type === 'repeatable') {\n        name = this.columns.systemRepeatableViewColumns[column.name];\n      }\n    } else if (column.element) {\n      name = column.element.data_name + (column.suffix || '');\n    }\n\n    if (name) {\n      // dedupe any columns\n      name = this.launderViewColumnName(table, column, name);\n    }\n\n    return name;\n  }\n\n  launderViewColumnName(table, column, name) {\n    const views = this.viewColumns;\n\n    views[table.name] = views[table.name] || {};\n\n    let count = 1;\n\n    let rawName = name.substring(0, 63);\n    let newName = rawName;\n\n    while (views[table.name][newName]) {\n      newName = rawName.substring(0, 63 - (count.toString().length)) + count;\n      count++;\n    }\n\n    views[table.name][newName] = column;\n\n    return newName;\n  }\n\n  processElement(element, elementTable) {\n    switch (element.type) {\n      case 'TextField':\n        if (element.numeric) {\n          this.addDoubleElement(elementTable, element);\n        } else {\n          this.addStringElement(elementTable, element);\n        }\n        break;\n\n      case 'ChoiceField':\n        if (element.multiple) {\n          this.addArrayElement(elementTable, element);\n        } else {\n          this.addStringElement(elementTable, element);\n        }\n        break;\n\n      case 'ClassificationField':\n        this.addArrayElement(elementTable, element);\n        break;\n\n      case 'YesNoField':\n        this.addStringElement(elementTable, element);\n        break;\n\n      case 'PhotoField':\n      case 'VideoField':\n      case 'AudioField':\n        this.addMediaElement(elementTable, element);\n        break;\n\n      case 'SignatureField':\n        this.addStringElement(elementTable, element);\n        this.addDateElement(elementTable, element, 'timestamp');\n        break;\n\n      case 'BarcodeField':\n        this.addStringElement(elementTable, element);\n        break;\n\n      case 'DateTimeField':\n      case 'DateField':\n        this.addDateElement(elementTable, element);\n        break;\n\n      case 'TimeField':\n        this.addDoubleElement(elementTable, element);\n        break;\n\n      case 'Repeatable':\n        this.addRepeatableElement(elementTable, element);\n        break;\n\n      case 'AddressField':\n        this.addStringElement(elementTable, element);\n        this.addStringElement(elementTable, element, 'sub_thoroughfare');\n        this.addStringElement(elementTable, element, 'thoroughfare');\n        this.addStringElement(elementTable, element, 'suite');\n        this.addStringElement(elementTable, element, 'locality');\n        this.addStringElement(elementTable, element, 'admin_area');\n        this.addStringElement(elementTable, element, 'postal_code');\n        this.addStringElement(elementTable, element, 'sub_admin_area');\n        this.addStringElement(elementTable, element, 'country');\n        break;\n\n      case 'HyperlinkField':\n        this.addStringElement(elementTable, element);\n        break;\n\n      case 'RecordLinkField':\n        this.addArrayElement(elementTable, element);\n        break;\n\n      case 'CalculatedField':\n        switch (element.display.style) {\n          case 'number':\n          case 'date':\n          case 'currency':\n            this.addDoubleElement(elementTable, element);\n            break;\n          default:\n            this.addStringElement(elementTable, element);\n            break;\n        }\n        break;\n\n      default:\n        console.log('Unhandled element type', element.type);\n        break;\n    }\n  }\n\n  addStringElement(table, element, suffix) {\n    if (suffix == null) {\n      suffix = '';\n    }\n    return this.addElement(table, element, 'string', suffix);\n  }\n\n  addDateElement(table, element, suffix) {\n    if (suffix == null) {\n      suffix = '';\n    }\n    return this.addElement(table, element, 'date', suffix);\n  }\n\n  addDoubleElement(table, element, suffix) {\n    if (suffix == null) {\n      suffix = '';\n    }\n    return this.addElement(table, element, 'double', suffix);\n  }\n\n  addIntegerElement(table, element, suffix) {\n    if (suffix == null) {\n      suffix = '';\n    }\n    return this.addElement(table, element, 'integer', suffix);\n  }\n\n  addArrayElement(table, element, suffix) {\n    if (suffix == null) {\n      suffix = '';\n    }\n    return this.addElement(table, element, 'array', suffix);\n  }\n\n  addElement(table, element, type, suffix) {\n    let column = null;\n\n    if (suffix == null) {\n      suffix = '';\n    }\n\n    if (suffix) {\n      suffix = '_' + suffix;\n    }\n\n    column = {\n      id: this.prefix + element.key + suffix,\n      type: type,\n      element: element,\n      suffix: suffix\n    };\n\n    table.addColumn(column);\n  }\n\n  addMediaElement(table, element) {\n    this.addArrayElement(table, element);\n\n    if (this.columns.includeMediaCaptions !== false) {\n      return this.addArrayElement(table, element, 'captions');\n    }\n  }\n\n  addRepeatableElement(parentTable, element) {\n    const childTable = this.buildRepeatableTable(parentTable, element);\n\n    this.tables.push(childTable);\n\n    const elements = Utils.flattenElements(element.elements, false);\n\n    const childElements = DataElements.find(elements);\n\n    for (const childElement of childElements) {\n      this.processElement(childElement, childTable);\n    }\n  }\n}\n"]}