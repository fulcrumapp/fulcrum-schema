{"version":3,"sources":["../src/schema.js"],"names":["Table","sqldiff","View","SIMPLE_TYPES","Schema","form","columns","options","prefix","elements","Utils","flattenElements","schemaElements","DataElements","find","buildSchema","calculatedFieldDateFormat","tables","views","formTable","buildFormTable","valuesTable","buildValuesTable","push","buildDataColumns","buildViews","buildIndexes","part","escapePart","partName","escapeDataName","escapeSlashes","name","dataName","replace","table","row_id","type","alias","form_id","id","systemFormTableColumns","column","formColumn","_","clone","system","maybeComplexType","addColumn","onAddFormTable","schema","systemValuesTableColumns","valueColumn","parentTable","element","key","parent","data_name","systemRepeatableTableColumns","attrs","onAddRepeatableTable","processElement","viewColumns","view","buildViewForTable","fullView","variant","columnNames","viewColumnName","indexDefinitions","systemFormTableIndexes","systemRepeatableTableIndexes","systemValuesTableIndexes","index","indexDefinition","isComplex","method","skip","disableComplexTypes","addIndex","systemFormFullViewColumns","systemFormViewColumns","systemRepeatableFullViewColumns","systemRepeatableViewColumns","systemValuesViewColumns","suffix","launderViewColumnName","count","rawName","substring","toLowerCase","newName","toString","length","elementTable","numeric","addDoubleElement","addStringElement","multiple","addArrayElement","addMediaElement","addTimestampElement","addDateElement","addTimeElement","addRepeatableElement","addRecordLinkElement","display","style","console","log","addElement","dataType","disableArrays","indexOf","includeMediaCaptions","includeMediaURLs","includeMediaViewURLs","value","clause","filter","PhotoField","VideoField","AudioField","childTable","buildRepeatableTable","childElements","childElement"],"mappings":"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","file":"schema.js","sourcesContent":["import _ from 'underscore';\nimport Utils from './utils';\nimport sqldiff from 'sqldiff';\nimport {format} from 'util';\nimport DataElements from './data-elements';\n\nconst {Table, View} = sqldiff;\n\nconst SIMPLE_TYPES = [\n  'pk',\n  'text',\n  'string',\n  'date',\n  'time',\n  'timestamp',\n  'double',\n  'integer',\n  'boolean'\n];\n\nexport default class Schema {\n  constructor(form, columns, options) {\n    this.prefix = 'f';\n    this.form = form;\n    this.columns = columns;\n    this.options = options || {};\n    this.elements = Utils.flattenElements(this.form.elements, false);\n    this.schemaElements = DataElements.find(this.elements);\n    this.buildSchema();\n\n    columns.calculatedFieldDateFormat = columns.calculatedFieldDateFormat === 'date' ? 'date' : 'double';\n  }\n\n  buildSchema() {\n    this.tables = [];\n    this.views = [];\n\n    this.formTable = this.buildFormTable();\n    this.valuesTable = this.buildValuesTable();\n\n    this.tables.push(this.formTable);\n    this.tables.push(this.valuesTable);\n\n    this.buildDataColumns();\n\n    this.buildViews();\n\n    this.buildIndexes();\n  }\n\n  alias(part, escapePart = true) {\n    if (part) {\n      const partName = escapePart ? this.escapeDataName(part) : part;\n\n      return this.escapeSlashes(this.form.name) + '/' + this.escapeSlashes(partName);\n    }\n    return this.escapeSlashes(this.form.name);\n  }\n\n  escapeDataName(dataName) {\n    // if a data name starts with an underscore, add an additional underscore to prevent\n    // collisions with future system-defined columns. e.g. `_symbol` becomes `__symbol`\n    // because at some point we might add a system column named `symbol` which needs the\n    // `_symbol` name.\n    if (dataName && dataName[0] === '_') {\n      return '_' + dataName;\n    }\n\n    return dataName || 'no_data_name';\n  }\n\n  escapeSlashes(name) {\n    return name.replace(/\\//g, '\\\\/');\n  }\n\n  buildFormTable() {\n    const table = new Table(format('form_%s', this.form.row_id),\n                            null,\n                            {type: 'form', alias: this.alias(), form_id: this.form.id});\n\n    for (const column of this.columns.systemFormTableColumns) {\n      const formColumn = _.clone(column);\n\n      formColumn.system = true;\n      formColumn.type = this.maybeComplexType(formColumn.type);\n\n      table.addColumn(formColumn);\n    }\n\n    if (this.options.onAddFormTable) {\n      this.options.onAddFormTable({table, form: this.form, schema: this});\n    }\n\n    return table;\n  }\n\n  buildValuesTable() {\n    const table = new Table(format('form_%s_values', this.form.row_id),\n                            null,\n                            {type: 'values', alias: this.alias('values'), form_id: this.form.id});\n\n    for (const column of this.columns.systemValuesTableColumns) {\n      const valueColumn = _.clone(column);\n\n      valueColumn.system = true;\n      valueColumn.type = this.maybeComplexType(valueColumn.type);\n\n      table.addColumn(valueColumn);\n    }\n\n    return table;\n  }\n\n  buildRepeatableTable(parentTable, element) {\n    const table = new Table(this.formTable.id + '_' + element.key,\n                            null,\n                            {type: 'repeatable', parent: parentTable, element: element, alias: this.alias(element.data_name), form_id: this.form.id});\n\n    for (const column of this.columns.systemRepeatableTableColumns) {\n      const attrs = _.clone(column);\n\n      attrs.id = element.key + '_' + column.name;\n      attrs.system = true;\n      attrs.type = this.maybeComplexType(attrs.type);\n\n      table.addColumn(attrs);\n    }\n\n    if (this.options.onAddRepeatableTable) {\n      this.options.onAddRepeatableTable({table, parentTable, element, form: this.form, schema: this});\n    }\n\n    return table;\n  }\n\n  buildDataColumns() {\n    for (const element of this.schemaElements) {\n      this.processElement(element, this.formTable);\n    }\n  }\n\n  buildViews() {\n    this.viewColumns = {};\n\n    for (const table of this.tables) {\n      const view = new View(table.name + '_view', null, table);\n\n      this.buildViewForTable(table, view);\n\n      this.views.push(view);\n\n      if (table.type === 'form') {\n        const fullView = new View(table.name + '_view_full', null, table, {variant: 'full', alias: this.alias('_full', false)});\n\n        this.buildViewForTable(table, fullView);\n\n        this.views.push(fullView);\n      } else if (table.type === 'repeatable') {\n        const fullView = new View(table.name + '_view_full', null, table, {variant: 'full',\n                                                                           alias: this.alias(table.element.data_name) + '/_full'});\n\n        this.buildViewForTable(table, fullView);\n\n        this.views.push(fullView);\n      }\n    }\n  }\n\n  buildViewForTable(table, view) {\n    const columnNames = {};\n\n    for (const column of table.columns) {\n      const alias = this.viewColumnName(view, table, column);\n\n      if (alias == null) {\n        continue;\n      }\n\n      if (!columnNames[alias]) {\n        view.addColumn({column: column, alias: alias});\n        columnNames[alias] = column;\n      }\n    }\n  }\n\n  buildIndexes() {\n    for (const table of this.tables) {\n      let indexDefinitions = [];\n\n      if (table.type === 'form') {\n        indexDefinitions = this.columns.systemFormTableIndexes;\n      } else if (table.type === 'repeatable') {\n        indexDefinitions = this.columns.systemRepeatableTableIndexes;\n      } else if (table.type === 'values') {\n        indexDefinitions = this.columns.systemValuesTableIndexes;\n      }\n\n      for (const index of indexDefinitions) {\n        const indexDefinition = _.clone(index);\n\n        const isComplex = indexDefinition.method === 'gist' || indexDefinition.method === 'gin';\n\n        const skip = isComplex && this.columns.disableComplexTypes === true;\n\n        if (!skip) {\n          table.addIndex(indexDefinition);\n        }\n      }\n    }\n  }\n\n  viewColumnName(view, table, column) {\n    let name = null;\n\n    if (column.system) {\n      if (table.type === 'form') {\n        if (view.variant === 'full') {\n          name = this.columns.systemFormFullViewColumns[column.name];\n        } else {\n          name = this.columns.systemFormViewColumns[column.name];\n        }\n      } else if (table.type === 'repeatable') {\n        if (view.variant === 'full') {\n          name = this.columns.systemRepeatableFullViewColumns[column.name];\n        } else {\n          name = this.columns.systemRepeatableViewColumns[column.name];\n        }\n      } else if (table.type === 'values') {\n        name = this.columns.systemValuesViewColumns[column.name];\n      }\n\n      if (name == null) {\n        return null;\n      }\n\n      name = '_' + name;\n    } else if (column.element) {\n      name = this.escapeDataName(column.element.data_name) + (column.suffix || '');\n    } else {\n      name = column.name + (column.suffix || '');\n    }\n\n    if (name) {\n      // dedupe any columns\n      name = this.launderViewColumnName(view, column, name);\n    }\n\n    return name;\n  }\n\n  launderViewColumnName(view, column, name) {\n    const views = this.viewColumns;\n\n    views[view.name] = views[view.name] || {};\n\n    let count = 1;\n\n    const rawName = name.substring(0, 63).toLowerCase();\n    let newName = rawName;\n\n    while (views[view.name][newName]) {\n      newName = rawName.substring(0, 63 - (count.toString().length)) + count;\n      count++;\n    }\n\n    views[view.name][newName] = column;\n\n    return newName;\n  }\n\n  processElement(element, elementTable) {\n    switch (element.type) {\n      case 'TextField':\n        if (element.numeric) {\n          this.addDoubleElement(elementTable, element);\n        } else {\n          this.addStringElement(elementTable, element);\n        }\n        break;\n\n      case 'ChoiceField':\n        if (element.multiple) {\n          this.addArrayElement(elementTable, element);\n        } else {\n          this.addStringElement(elementTable, element);\n        }\n        break;\n\n      case 'ClassificationField':\n        this.addArrayElement(elementTable, element);\n        break;\n\n      case 'YesNoField':\n        this.addStringElement(elementTable, element);\n        break;\n\n      case 'PhotoField':\n      case 'VideoField':\n      case 'AudioField':\n        this.addMediaElement(elementTable, element);\n        break;\n\n      case 'SignatureField':\n        this.addStringElement(elementTable, element);\n        this.addTimestampElement(elementTable, element, 'timestamp');\n        break;\n\n      case 'BarcodeField':\n        this.addStringElement(elementTable, element);\n        break;\n\n      case 'DateTimeField':\n      case 'DateField':\n        this.addDateElement(elementTable, element);\n        break;\n\n      case 'TimeField':\n        this.addTimeElement(elementTable, element);\n        break;\n\n      case 'Repeatable':\n        this.addRepeatableElement(elementTable, element);\n        break;\n\n      case 'AddressField':\n        this.addStringElement(elementTable, element);\n        this.addStringElement(elementTable, element, 'sub_thoroughfare');\n        this.addStringElement(elementTable, element, 'thoroughfare');\n        this.addStringElement(elementTable, element, 'suite');\n        this.addStringElement(elementTable, element, 'locality');\n        this.addStringElement(elementTable, element, 'admin_area');\n        this.addStringElement(elementTable, element, 'postal_code');\n        this.addStringElement(elementTable, element, 'sub_admin_area');\n        this.addStringElement(elementTable, element, 'country');\n        break;\n\n      case 'HyperlinkField':\n        this.addStringElement(elementTable, element);\n        break;\n\n      case 'RecordLinkField':\n        this.addRecordLinkElement(elementTable, element);\n        break;\n\n      case 'CalculatedField':\n        switch (element.display.style) {\n          case 'date':\n            if (this.columns.calculatedFieldDateFormat === 'date') {\n              this.addDateElement(elementTable, element);\n            } else {\n              this.addDoubleElement(elementTable, element);\n            }\n            break;\n          case 'number':\n          case 'currency':\n            this.addDoubleElement(elementTable, element);\n            break;\n          default:\n            this.addStringElement(elementTable, element);\n            break;\n        }\n        break;\n\n      default:\n        console.log('Unhandled element type', element.type);\n        break;\n    }\n  }\n\n  addStringColumn(table, name, suffix) {\n    if (suffix == null) {\n      suffix = '';\n    }\n    return this.addColumn(table, name, 'string', suffix);\n  }\n\n  addStringElement(table, element, suffix) {\n    if (suffix == null) {\n      suffix = '';\n    }\n    return this.addElement(table, element, 'string', suffix);\n  }\n\n  addDateElement(table, element, suffix) {\n    if (suffix == null) {\n      suffix = '';\n    }\n    return this.addElement(table, element, 'date', suffix);\n  }\n\n  addTimeElement(table, element, suffix) {\n    if (suffix == null) {\n      suffix = '';\n    }\n    return this.addElement(table, element, 'time', suffix);\n  }\n\n  addTimestampElement(table, element, suffix) {\n    if (suffix == null) {\n      suffix = '';\n    }\n    return this.addElement(table, element, 'timestamp', suffix);\n  }\n\n  addDoubleElement(table, element, suffix) {\n    if (suffix == null) {\n      suffix = '';\n    }\n    return this.addElement(table, element, 'double', suffix);\n  }\n\n  addIntegerElement(table, element, suffix) {\n    if (suffix == null) {\n      suffix = '';\n    }\n    return this.addElement(table, element, 'integer', suffix);\n  }\n\n  addArrayElement(table, element, suffix) {\n    if (suffix == null) {\n      suffix = '';\n    }\n\n    const dataType = this.columns.disableArrays === true ? 'string' : 'array';\n\n    return this.addElement(table, element, dataType, suffix);\n  }\n\n  addColumn(table, name, type, suffix) {\n    let column = null;\n\n    if (suffix == null) {\n      suffix = '';\n    }\n\n    if (suffix) {\n      suffix = '_' + suffix;\n    }\n\n    column = {\n      id: name + suffix,\n      type: this.maybeComplexType(type),\n      element: null,\n      suffix: suffix\n    };\n\n    table.addColumn(column);\n  }\n\n  addElement(table, element, type, suffix) {\n    let column = null;\n\n    if (suffix == null) {\n      suffix = '';\n    }\n\n    if (suffix) {\n      suffix = '_' + suffix;\n    }\n\n    column = {\n      id: this.prefix + element.key + suffix,\n      type: this.maybeComplexType(type),\n      element: element,\n      suffix: suffix\n    };\n\n    table.addColumn(column);\n  }\n\n  maybeComplexType(type) {\n    const isComplex = SIMPLE_TYPES.indexOf(type) === -1;\n\n    return isComplex && this.columns.disableComplexTypes === true ? 'string' : type;\n  }\n\n  addMediaElement(table, element) {\n    this.addArrayElement(table, element);\n\n    if (this.columns.includeMediaCaptions !== false) {\n      this.addArrayElement(table, element, 'captions');\n    }\n\n    if (this.columns.includeMediaURLs) {\n      this.addArrayElement(table, element, 'urls');\n    }\n\n    if (this.columns.includeMediaViewURLs) {\n      this.addStringElement(table, element, 'view_url');\n    }\n\n    const value = element.key.replace(/'/g, \"''\");\n\n    const clause = format('WHERE key = \\'%s\\'', value);\n\n    const filter = {\n      key: value\n    };\n\n    const alias = {\n      PhotoField: '_photo_id',\n      VideoField: '_video_id',\n      AudioField: '_audio_id'\n    }[element.type];\n\n    if (alias) {\n      const view = new View(this.formTable.id + '_' + element.key + '_view',\n                            null, this.valuesTable, {type: 'media', element: element, clause: clause, filter, alias: this.alias(element.data_name)});\n\n      view.addColumn({column: {name: 'record_resource_id', type: 'string'}, alias: 'record_id'});\n      view.addColumn({column: {name: 'parent_resource_id', type: 'string'}, alias: 'parent_id'});\n      view.addColumn({column: {name: 'text_value', type: 'string'}, alias: alias});\n\n      this.views.push(view);\n    }\n  }\n\n  addRecordLinkElement(parentTable, element) {\n    this.addArrayElement(parentTable, element);\n\n    const value = element.key.replace(/'/g, \"''\");\n\n    const clause = format('WHERE key = \\'%s\\'', value);\n\n    const view = new View(this.formTable.id + '_' + element.key + '_view',\n                          null, this.valuesTable, {type: 'link', element: element, clause: clause, alias: this.alias(element.data_name)});\n\n    view.addColumn({column: {name: 'record_resource_id', type: 'string'}, alias: 'source_record_id'});\n    view.addColumn({column: {name: 'parent_resource_id', type: 'string'}, alias: 'parent_id'});\n    view.addColumn({column: {name: 'text_value', type: 'string'}, alias: 'linked_record_id'});\n\n    this.views.push(view);\n  }\n\n  addRepeatableElement(parentTable, element) {\n    const childTable = this.buildRepeatableTable(parentTable, element);\n\n    this.tables.push(childTable);\n\n    const elements = Utils.flattenElements(element.elements, false);\n\n    const childElements = DataElements.find(elements);\n\n    for (const childElement of childElements) {\n      this.processElement(childElement, childTable);\n    }\n  }\n}\n"]}